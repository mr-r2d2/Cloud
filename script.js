"use strict";XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(e){for(var n=e.length,t=new Uint8Array(n),o=0;o<n;o++)t[o]=255&e.charCodeAt(o);this.send(t)});var AJAXSubmit=function(){function e(){console.log(this.responseText),runRefresh()}function n(n){n.status>0||(console.log("AJAXSubmit - The form is now serialized. Submitting..."),function(n){var t=new XMLHttpRequest;if(t.submittedData=n,t.onload=e,0===n.technique)t.open("get",n.receiver.replace(/(?:\?.*)?$/,n.segments.length>0?"?"+n.segments.join("&"):""),!0),t.send(null);else if(t.open("post",n.receiver,!0),3===n.technique){var o="---------------------------"+Date.now().toString(16);t.setRequestHeader("Content-Type","multipart/form-data; boundary="+o),t.sendAsBinary("--"+o+"\r\n"+n.segments.join("--"+o+"\r\n")+"--"+o+"--\r\n")}else t.setRequestHeader("Content-Type",n.contentType),t.send(n.segments.join(2===n.technique?"\r\n":"&"))}(n))}function t(e){this.owner.segments[this.segmentIdx]+=e.target.result+"\r\n",this.owner.status--,n(this.owner)}function o(e){return e.replace(/[\s\=\\]/g,"\\$&")}function l(e){var l,r,a,i,s,d="post"===e.method.toLowerCase();this.contentType=d&&e.enctype?e.enctype:"application/x-www-form-urlencoded",this.technique=d?"multipart/form-data"===this.contentType?3:"text/plain"===this.contentType?2:1:0,this.receiver=e.action,this.status=0,this.segments=[];for(var u=2===this.technique?o:escape,c=0;c<e.elements.length;c++)if((a=e.elements[c]).hasAttribute("name"))if("FILE"===(r="INPUT"===a.nodeName.toUpperCase()?a.getAttribute("type").toUpperCase():"TEXT")&&a.files.length>0)if(3===this.technique)for(l=0;l<a.files.length;l++)s=a.files[l],(i=new FileReader).segmentIdx=this.segments.length,i.owner=this,i.onload=t,this.segments.push('Content-Disposition: form-data; name="'+a.name+'"; filename="'+s.name+'"\r\nContent-Type: '+s.type+"\r\n\r\n"),this.status++,i.readAsBinaryString(s);else for(l=0;l<a.files.length;this.segments.push(u(a.name)+"="+u(a.files[l++].name)));else("RADIO"!==r&&"CHECKBOX"!==r||a.checked)&&this.segments.push(3===this.technique?'Content-Disposition: form-data; name="'+a.name+'"\r\n\r\n'+a.value+"\r\n":u(a.name)+"="+u(a.value));n(this)}return function(e){e.action&&new l(e)}}();function ready(e){"loading"!=document.readyState?e():document.addEventListener("DOMContentLoaded",e)}function post_ajax(e,n){var t=new XMLHttpRequest;t.open("POST",e,!0),t.onload=function(){if(this.status>=200&&this.status<400){return JSON.parse(this.response)}return!1},t.send(n)}function getCookie(e){var n=document.cookie.match("(^|;) ?"+encodeURIComponent(e)+"=([^;]*)(;|$)");return n?decodeURIComponent(n[2]):null}function setCookie(e,n,t){var o=new Date;o.setTime(o.getTime()+864e5*t),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(n)+"; path=/; expires="+o.toGMTString()+";SameSite=Strict"}function deleteCookie(e){setCookie(encodeURIComponent(e),"",-1)}function runRefresh(){startProgress(),loggedin()&&refreshTable(void 0,getCookie("folder__id"),getCookie("parent__folder__id")),unblockLogin(loggedin()),endProgress()}function startProgress(){document.body.style.cursor="progress";const e=document.querySelector(".block_loading");e&&null!=e&&null!=e?e.style.display="block":console.debug("Cannot find loadingElem: .block_loading")}function endProgress(){document.body.style.cursor="default";const e=document.querySelector(".block_loading");e&&null!=e&&null!=e?e.style.display="none":console.debug("Cannot find loadingElem: .block_loading")}function runAfterJSReady(){startProgress(),removeLinkSchedule(),removeLinkConfirm(),renameLinkPrompt(),publicLinkConfirm(),folderLink(),endProgress()}function handleUploadForm(e=".upload"){const n=document.querySelector(e);n&&null!=n&&null!=n?(document.querySelector(".custom-file-input").addEventListener("change",(function(e){var n=document.getElementById("customFile").files[0].name;e.target.nextElementSibling.innerText=n})),n.addEventListener("submit",e=>{e.preventDefault(),startProgress(),console.debug("AJAX Form sent"),loggedin()?(AJAXSubmit(n),document.querySelector(".custom-file-label").innerText="Выберите файл"):console.warn("please, login to upload files")})):console.debug("Cannot find form: "+e)}function refreshTable(e=".files tbody",n=1,t=1){if(!loggedin())return void console.warn("please, login to see your files");const o=document.querySelector(e),l=document.querySelector(".filesList tbody");if(null==o||null==o)return void console.debug("Cannot find table: "+e);if(null==l||null==l)return void console.debug("Cannot find table: .filesList tbody");o.innerHTML="",l.innerHTML="";let r=new FormData;r.append("files_list","true"),r.append("parent_folder__id",n);var a=new XMLHttpRequest;a.open("POST","php/download.php",!0),a.onload=function(){if(this.status>=200&&this.status<400){let e=JSON.parse(this.response);if(!e||null==e||null==e||0==e.length)return console.debug("Cannot send request: "),void console.debug(r);if(e[0].error_text&&0<e[0].error_text.length&&console.debug("Error: "+e[0].error_text),e[0].status&&0==e[0].status)return void console.debug("Cannot show files");e.forEach(e=>{if(2==e.type){let t=o.insertRow(0);t.className="table__tr";let l=t.insertCell(0),r=t.insertCell(1);l.className="table__td align-middle",r.className="table__td align-middle",l.innerHTML='<a href="#folder'+e.id+'" class="link link_folder" data-folder__id="'+e.id+'" data-parent_folder_id="'+n+'"><i class="fa fa-folder"></i> '+e.real_name+"</a>",r.innerHTML='<a href="#folder'+e.id+'" class="btn btn-success link_folder mx-1" data-folder__id="'+e.id+'" data-parent_folder_id="'+n+'" title="Open '+e.real_name+'"><i class="fa fa-sign-in"></i></a>',r.innerHTML+='<a href="#rename__file-'+e.id+'" class="btn btn-primary link_rename mx-1" data-file__id="'+e.id+'" data-file__name="'+e.real_name+'" title="Rename '+e.real_name+'"><i class="fa fa-pencil"></i></a>',r.innerHTML+='<a href="php/remove.php?remove_file__id='+e.id+'" class="btn btn-danger link_remove mx-1" data-file_id="'+e.id+'" data-real_name="'+e.real_name+'" title="Remove '+e.real_name+'"><i class="fa fa-trash"></i></a>'}else if(1==e.type){let n=l.insertRow(0);n.className="table__tr";let t,o=n.insertCell(0),r=n.insertCell(1);o.className="table__td align-middle",r.className="table__td align-middle m-0",o.innerHTML='                    <div class="row_inline">                        <a href="php/download.php?download_file__id='+e.id+'" class="link link_download" title="Download '+e.real_name+'"><i class="fa fa-file-text-o m-1"></i> '+e.real_name+"</a>                    </div>",t='<div class="btn-group dropleft"><button type="button" class="btn btn-danger mx-1  dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fa fa-clock-o"></i></button><div class="dropdown-menu m-0 p-0 mr-1 border-0"><div class="btn-group dropdown-item p-0" role="group"><button type="dropdown-item" class="btn btn-primary d-none d-lg-block" disabled >Через: </button>',t+='<a href="php/remove.php?remove_file__id='+e.id+'&timer=1" type="dropdown-item"  class="btn btn-primary link_remove schedul" data-timer="1" data-file_id="'+e.id+'" data-real_name="'+e.real_name+'" title="Отложенное удаление '+e.real_name+'">1 s</a>',t+='<a href="php/remove.php?remove_file__id='+e.id+'&timer=30" type="dropdown-item"  class="btn btn-primary link_remove schedul" data-timer="30" data-file_id="'+e.id+'" data-real_name="'+e.real_name+'" title="Отложенное удаление '+e.real_name+'">30 s</a>',t+='<a href="php/remove.php?remove_file__id='+e.id+'&timer=60" type="dropdown-item"  class="btn btn-primary link_remove schedul" data-timer="60" data-file_id="'+e.id+'" data-real_name="'+e.real_name+'" title="Отложенное удаление '+e.real_name+'">1 min</a>',t+="</div></div></div>",r.innerHTML=t,r.innerHTML+='<a href="php/download.php?download_file__id='+e.id+'" class="btn btn-success mx-1" data-file__id="'+e.id+'" title="Download '+e.real_name+'"><i class="fa fa-download"></i></a>',r.innerHTML+='<a href="#public_link__id='+e.id+'" class="btn btn-info link_public mx-1" data-file__id="'+e.id+'" title="Get Public Link for '+e.real_name+'"><i class="fa fa-link fa-flip-horizontal"></i></a>',r.innerHTML+='<a href="#rename__file-'+e.id+'" class="btn btn-primary link_rename mx-1" data-file__id="'+e.id+'" data-file__name="'+e.real_name+'" title="Rename '+e.real_name+'"><i class="fa fa-pencil"></i></a>',r.innerHTML+='<a href="php/remove.php?remove_file__id='+e.id+'" class="btn btn-danger link_remove mx-1" data-file_id="'+e.id+'" data-real_name="'+e.real_name+'" title="Remove '+e.real_name+'"><i class="fa fa-trash"></i></a>'}})}else{let e=o.insertRow(0);e.className="table__tr";let n=e.insertCell(0);n.className="table__td",n.innerText="Эта папка пуста.",n.setAttribute("colspan","2")}let e=document.querySelector(".go_back");e.innerHTML="",1!=n&&(e.innerHTML='<a href="#folderBack'+t+'" class="link link_folder btn btn-info btn-sm" data-folder__id="'+t+'" title="Previous folder"><i class="fa fa-arrow-left" aria-hidden="true"></i> Назад</a>'),runAfterJSReady()},loggedin()?a.send(r):console.warn("please, login to see your files")}function renameLinkPrompt(e=".link_rename"){const n=document.querySelectorAll(e);null==n||0>=n.length?console.log("Cannot find rename links: "+e):n.forEach(e=>{e.addEventListener("click",(function(n){n.preventDefault();var t=window.prompt("New name:",e.dataset.file__name);if(!t||t==e.dataset.file__name)return!1;startProgress();let o=new FormData;o.append("file__rename","true"),o.append("file__id",e.dataset.file__id),o.append("file__name",t);var l=new XMLHttpRequest;l.open("POST","php/update.php",!0),l.onload=function(){if(!(this.status>=200&&this.status<400))return console.debug("We reached our target server, but it returned an error"),!1;runRefresh()},l.send(o)}))})}function handleAddFolder(e="#add_folder"){const n=document.querySelector(e);n&&null!=n&&null!=n?n.addEventListener("click",(function(e){let t=document.getElementById("folder_name").value;if(startProgress(),!t||null==t||null==t||0==t.length)return console.debug("Empty new name"),void endProgress();let o=new FormData;o.append("add_folder","true"),o.append("add_folder__name",t),o.append("parent_folder__id",n.dataset.folder_id);var l=new XMLHttpRequest;l.open("POST","php/upload.php",!0),l.onload=function(){if(!(this.status>=200&&this.status<400))return console.debug("We reached our target server, but it returned an error"),!1;{let e=JSON.parse(this.response);if(!e||null==e||null==e||0==e.length)return console.debug("Cannot get answer from server with data:"),void console.debug(o);document.getElementById("folder_name").value="",console.debug(e),runRefresh()}},l.send(o)})):console.debug("Cannot find button: "+e)}function loggedin(){let e=getCookie("user__loggedin");return!(!e||null==e||null==e||1!=e)}function loginHandler(e="#login"){const n=document.querySelector(e);null!=n&&null!=n?n.addEventListener("submit",e=>{e.preventDefault(),startProgress(),console.debug("Login Form sent via AJAX"),console.debug('AJAXSubmit("formLoginElem"'),console.debug(n),AJAXSubmit(n)}):console.debug("Cannot find Login form: "+e)}function setFolderPathCookie(e=1,n=1){setCookie("folder__id",e,1),setCookie("parent__folder__id",n,1)}function setUserName(e=".user_name"){if(!loggedin())return void console.warn("please, login to see your files");const n=document.querySelector(e);if(null==n||null==n)return void console.debug("Cannot find user name elem: "+e);let t=getCookie("user__name");t&&null!=t&&null!=t?n.innerText=t:console.debug("Cannot find user name Cookie.")}function unblockLogin(e){let n=document.querySelectorAll(".block_private"),t=document.querySelectorAll(".block_public");e&&(setUserName(),(n||null!=n||null!=n)&&n.forEach(e=>{e.classList.remove("block_private")}),(t||null!=t||null!=t)&&t.forEach(e=>{e.classList.remove("block_public"),e.classList.add("block_hidden")}))}function removeLinkConfirm(e=".link_remove"){const n=document.querySelectorAll(e);null==n||0>=n.length?console.log("Cannot find remove links: "+e):n.forEach(e=>{e.addEventListener("click",(function(n){var t=window.confirm("Do you really want to remove "+e.dataset.real_name+" ?");startProgress(),t||(n.preventDefault(),endProgress())}))})}function removeLinkSchedule(e=".schedul"){const n=document.querySelectorAll(e);null==n||0>=n.length?console.log("Cannot find remove links: "+e):n.forEach(e=>{e.addEventListener("click",(function(n){setTimeout((function(){runRefresh()}),1e3*e.dataset.timer)}))})}function publicLinkConfirm(e=".link_public"){const n=document.querySelectorAll(e);null==n||0>=n.length?console.log("Cannot find public links: "+e):n.forEach(e=>{e.addEventListener("click",(function(n){n.preventDefault(),startProgress();let t=new FormData;t.append("get_public_link","true"),t.append("file__id",e.dataset.file__id);var o=new XMLHttpRequest;o.open("POST","php/download.php",!0),o.onload=function(){if(!(this.status>=200&&this.status<400))return console.debug("We reached our target server, but it returned an error"),!1;var e=JSON.parse(this.response);if(!e||null==e||null==e||0==e.length)return console.debug("Cannot answer: "),void console.debug(t);alert(window.location.protocol+"//"+window.location.hostname+window.location.pathname+"php/download.php?public_link="+e.public_link),runRefresh(),endProgress()},o.send(t)}))})}function folderLink(e=".link_folder"){const n=document.querySelectorAll(e);null==n||0>=n.length?console.log("Cannot find folder links: "+e):n.forEach(e=>{e.addEventListener("click",(function(n){n.preventDefault(),startProgress(),refreshTable(".files tbody",e.dataset.folder__id,e.dataset.parent_folder_id),setFolderPathCookie(e.dataset.folder__id,e.dataset.parent_folder_id);const t=document.querySelector(".upload");if(!t||null==t||null==t)return void console.debug("Cannot find form: .upload");t.parent_folder__id.value=e.dataset.folder__id;const o=document.querySelector("#add_folder");o&&null!=o&&null!=o?o.dataset.folder_id=e.dataset.folder__id:console.debug("Cannot find button: #add_folder")}))})}ready((function(){startProgress(),loginHandler(),setFolderPathCookie(),refreshTable(),handleUploadForm(),handleAddFolder(),unblockLogin(loggedin()),setUserName(),endProgress()}));
//# sourceMappingURL=script.js.map